# 更新升级指南

## 快速更新

在终端输入 `dns` 命令唤醒管理菜单，选择 **6** 进行更新：

```bash
dns
```

```
请选择操作：

    1) 启动服务
    2) 停止服务
    3) 重启服务
    4) 查看状态
    5) 查看日志
    6) 更新程序    ← 选择此项
    7) 卸载程序
    0) 退出
```

输入 `6` 后回车，系统将自动完成更新。

---

## 更新前建议

### 备份数据（重要）

更新前建议备份数据库：

```bash
# 备份数据库
docker exec dns-mysql mysqldump -u root -p<密码> dns > backup_$(date +%Y%m%d).sql
```

---

## 版本回滚

如果新版本有问题，可以回滚到旧版本：

### 恢复备份

```bash
# 停止服务（在 dns 菜单中选择 2）
dns

# 恢复数据库
docker exec -i dns-mysql mysql -u root -p<密码> dns < backup_20241225.sql

# 启动服务（在 dns 菜单中选择 1）
dns
```

---

## 数据库迁移

系统支持自动数据库迁移，更新时会自动：

- 添加新字段
- 创建新表
- 迁移数据

**查看迁移日志**：

在 dns 菜单中选择 **5** 查看日志，如果看到类似输出，说明迁移成功：

```
[OK] Migrations applied: subdomains.ns_mode, users.totp_enabled, ...
```

---

## 常见更新问题

### 1. 更新失败

**解决**：
- 检查网络连接是否正常
- 在 dns 菜单中选择 **5** 查看日志，了解具体错误

### 2. 数据库迁移失败

**解决**：
- 在 dns 菜单中选择 **5** 查看详细错误日志
- 确保数据库服务正常运行

### 3. 更新后页面异常

**解决**：
- 清除浏览器缓存
- 或强制刷新：Ctrl + Shift + R
- 在 dns 菜单中选择 **3** 重启服务

---

## 版本历史

### v2.7 (当前版本)
- 套餐支持多域名关联
- 优化管理后台界面
- 修复已知问题

### v2.6
- 新增优惠券功能
- 新增 IP 黑名单
- 优化定时任务

### v2.5
- 新增 NS 托管切换
- 新增自动续费
- 新增 2FA 双因素认证

### v2.4
- 新增邮箱验证
- 新增公告系统
- 优化购买流程

---

## 检查更新

### 方法一：查看 Docker Hub

访问 [Docker Hub](https://hub.docker.com/r/167729539/dns/tags) 查看最新版本。

### 方法二：系统内检查

登录管理后台，系统会自动检查更新并提示。

---

## 更新最佳实践

1. **备份数据** - 更新前务必备份数据库
2. **查看更新日志** - 了解新版本的变更内容
3. **选择低峰期** - 在用户访问较少时更新
4. **保留回滚方案** - 保留数据库备份文件
